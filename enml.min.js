/*!
 * ENML JavaScript Library v0.5
 * http://github.com/danielmendel/enml.js
 *
 * Copyright 2010-2012, Daniel Espeset
 * MIT License.
 * http://github.com/danielmendel/enml.js/master/MIT-LICENSE.txt
 *
 * Date: Fri Dec 28 3:37:48 2012 -0700
 */(function(a){typeof exports=="undefined"?function(){var c=window.ENML;a(window.ENML={noConflict:function(){var a=window.ENML;return window.ENML=c,a}})}():a(exports)})(function(a){function b(a,b){if(typeof a=="undefined"||typeof b=="undefined")return!1;for(k in b)a[k]=b[k];return a}function c(a){return r=a,r.match(/^\s+|\s+$/g)&&(r=r.replace(/^\s+|\s+$/g,"")),r}a.parser=function(c){function h(a,b,c){var d=this;return d.parent=c,d.children=[],d.children.each=function(a){var b=this.length;for(var c=0;c<b;c++)a(this[c])},d.is=b,d.val=a,d.attr={},d}function i(){var a=this,b=new h("","root",null);return a.root=b,a.open=function(a){node=new h(a,"tag",b),a.match(g.reference)&&(node.is="reference"),a==="__esc"&&(node.is="escaped"),b.children.push(node),b=node},a.set=function(a,c){b.is="attr_tag",b.attr[a]=c},a.add=function(a){b.children.push(new h(a,"text",b))},a.close=function(){b.parent&&(b=b.parent)},a}function j(a){f=f.substring(a.length)}function k(a,b,c){var d=f.match(g[a]);d?b(d):typeof c=="function"&&c()}function l(){k("text",function(a){e.add(a[1]),j(a[0])}),k("escaped",function(a){e.open("__esc"),j(a[0])}),k("open",function(a){j(a[0]),k("name",function(a){e.open(a[1]),j(a[0]);var b=!0;while(b)k("attr",function(a){e.set(a[1],a[2].substring(1,a[2].length-1)),j(a[0])},function(){b=!1})},function(){})}),k("closed",function(a){e.close(),j(a[0])})}var d=this,e,f=[],g={open:/^\s*\[/,closed:/^\s*]/,name:/^\s*([A-Za-z0-9_-]+):/,attr:/^\s*([A-Za-z0-9_-]+)\s*=\s*('[^']+'|"[^"]+")/,text:/^(\s*[^\]\[]+)/,reference:/^\s*[0-9]+/,escaped:/^\s*\[\s*\//};return typeof c!="undefined"&&b(g,c),d.parse=function(a){f=a,e=new i;while(f)l();return e.root.children},d.inspect=function(){return g},d},a.grammar=function(e,f){function j(a,c){var d=this;return d.name=a,d.attr={},d.template="",d.force=!1,d.aliases=[],typeof c=="object"&&(c.attr=c.plus||c.attr||{},c.template=c.as||c.template||"",b(d,c)),typeof c=="string"&&(d.template=c),d}function l(){typeof g.definitions[g.indefinite.name]!="undefined"?g.indefinite.force&&(g.definitions[g.indefinite.name]=g.indefinite):g.definitions[g.indefinite.name]=g.indefinite}function m(a){typeof i.exiting[g.state]=="function"&&i.exiting[g.state](),g.state=a,typeof i.starting[g.state]=="function"&&i.starting[g.state]()}function n(a){return g.state===a}function p(a,b){var d="";return a.each(function(a){switch(a.is){case"text":d+=a.val;break;case"escaped":d+=g.definitions.__esc.template.replace("%TC",c(p(a.children,b)));break;case"tag":d+=g.definitions[a.val].template.replace("%TC",c(p(a.children,b)));break;case"reference":d+=g.definitions.__ref.template.replace("%TC",c(p(a.children,b))).replace("%REF",c(o["_"+a.val]));break;case"attr_tag":if(typeof g.definitions[a.val].template=="function"){var e={},f=g.definitions[a.val];b=b||{},e.tc=c(p(a.children,b));for(k in f.attr)f.attr.hasOwnProperty(k)&&(typeof f.attr[k]=="object"&&f.attr[k].hasOwnProperty("defaults_to")?e[k]=a.attr[k]||f.attr[k].defaults_to:e[k]=a.attr[k]||f.attr[k]);d+=f.template(b,e);break}var h=g.definitions[a.val].template.replace("%TC",c(p(a.children,b)));for(arg in a.attr)h=h.replace("%"+arg.toUpperCase(),a.attr[arg]);d+=h;break;case"source":}}),d}var g=this,h=new a.parser(f),i={starting:{},exiting:{}};g.name=e,g.state="uninitialized",g.definitions={},i.exiting.defining=function(){l()},g.syntax=function(b,c){return h=new a.parser({open:new RegExp("^\\s*"+b),closed:new RegExp("^\\s*"+c),text:new RegExp("^(\\s*[^"+b+c+"]+)")}),g},g.define=function(a){m("defining"),typeof a=="string"&&(g.indefinite=new j(a),arguments>1&&(g.indefinite.aliases=arguments.slice(1)));if(typeof a=="object")for(tag in a)g.indefinite=new j(tag,a[tag]),g.indefinite.force=!0,l();return g},g.by_force=function(){if(!n("defining"))throw"by_force was called but no ENML tag is being defined.";return g.indefinite.force=!0,g},g.plus=function(a){if(!n("defining"))throw"plus was called but no ENML tag is being defined";return g.indefinite.attr=a,g},g.as=function(a){if(!n("defining"))throw"as was called but no ENML tag is being defined";return g.indefinite.template=a,m("ready"),g},g.as.cssProxy=function(a){if(!n("defining"))throw"cssProxy was called but no ENML tag is being defined";return g.indefinite.template="<"+a+" class='"+g.indefinite.name+"'>%TC</"+a+">",m("ready"),g};var o={};g.parse=function(a,b){o={};var d=h.parse(a),e=d.length-1;if(d[e].is==="reference"){var f=!0;while(f)d[e].is==="reference"&&typeof o["_"+d[e].val]=="undefined"?(o["_"+d[e].val]=d[e].children[0].val,d[e].is="source",e--):f=!1}return c(p(d,b))},g.define("__ref").as("<a href='%REF'>%TC</a>"),g.define("__esc").as("[%TC]")}});